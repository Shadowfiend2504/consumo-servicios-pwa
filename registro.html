<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registro de Usuario - Control de Consumo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/estilos.css">
</head>

<body style="margin: 0; padding: 0;">
  <!-- Pantalla de Registro -->
  <div class="login-screen-layout">
    <!-- Lado izquierdo - Formulario -->
    <div class="login-form-container">
      <div class="login-form-content">

        <!-- Logo y Título -->
        <div class="text-center mb-3">
          <div class="brand-logo-large mb-3">
            <span class="brand-text">UAN</span>
          </div>
          <h2 style="color: var(--primary); font-weight: 600; font-size: 22px;">Crear Cuenta</h2>
          <p class="text-muted small">Regístrate para acceder al sistema</p>
        </div>

        <form id="formularioRegistro" onsubmit="registrarUsuario(event)">

          <!-- Nombre Completo -->
          <div class="mb-2">
            <label for="nombre" class="form-label fw-500 small">Nombre Completo <span
                class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i class="bi bi-person"></i>
              </span>
              <input type="text" id="nombre" class="form-control border-start-0" placeholder="Tu nombre" required>
            </div>
          </div>

          <!-- Email -->
          <div class="mb-2">
            <label for="email" class="form-label fw-500 small">Correo <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i class="bi bi-envelope"></i>
              </span>
              <input type="email" id="email" class="form-control border-start-0" placeholder="correo@ejemplo.com"
                required>
            </div>
          </div>

          <!-- Teléfono -->
          <div class="mb-2">
            <label for="telefono" class="form-label fw-500 small">Teléfono <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i class="bi bi-telephone"></i>
              </span>
              <input type="tel" id="telefono" class="form-control border-start-0" placeholder="+57 300 123 4567"
                required>
            </div>
          </div>

          <!-- Documento de Identidad -->
          <div class="mb-2">
            <label for="documento" class="form-label fw-500 small">Documento <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i class="bi bi-credit-card"></i>
              </span>
              <input type="text" id="documento" class="form-control border-start-0" placeholder="1234567890" required>
            </div>
          </div>

          <!-- Contraseña -->
          <div class="mb-2">
            <label for="password" class="form-label fw-500 small">Contraseña <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i class="bi bi-lock"></i>
              </span>
              <input type="password" id="password" class="form-control border-start-0" placeholder="Mín. 8 caracteres"
                minlength="8" required>
              <button class="btn btn-outline-secondary border-start-0" type="button"
                onclick="togglePasswordVisibility('password')">
                <i class="bi bi-eye" id="eye-icon"></i>
              </button>
            </div>
            <small class="text-muted d-block mt-1" style="font-size: 11px;">
              Mayúscula, número y símbolo
            </small>
          </div>

          <!-- Confirmar Contraseña -->
          <div class="mb-2">
            <label for="passwordConfirm" class="form-label fw-500 small">Confirmar <span
                class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i class="bi bi-lock-check"></i>
              </span>
              <input type="password" id="passwordConfirm" class="form-control border-start-0"
                placeholder="Repite tu contraseña" minlength="8" required>
              <button class="btn btn-outline-secondary border-start-0" type="button"
                onclick="togglePasswordVisibility('passwordConfirm')">
                <i class="bi bi-eye" id="eye-icon-confirm"></i>
              </button>
            </div>
          </div>

          <!-- Términos y Condiciones -->
          <div class="mb-3 mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="terminos" required>
              <label class="form-check-label small" for="terminos">
                Acepto los <a href="#" class="text-decoration-none" style="color: var(--accent);">términos</a> y
                <a href="#" class="text-decoration-none" style="color: var(--accent);">privacidad</a>
              </label>
            </div>
          </div>

          <!-- Botón de Registro -->
          <button type="submit" class="btn btn-primary w-100 fw-600 btn-sm mb-2">
            <i class="bi bi-check-circle"></i> Crear Cuenta
          </button>
        </form>

        <!-- Link a Login -->
        <div class="text-center" style="border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
          <p class="text-muted mb-0 small">
            ¿Ya tienes cuenta?
            <a href="index.html" class="text-decoration-none fw-600" style="color: var(--accent);">
              Inicia sesión
            </a>
          </p>
        </div>

        <!-- Información adicional -->
        <div class="alert alert-info alert-sm mt-3 d-flex align-items-start gap-2" role="alert">
          <i class="bi bi-shield-check" style="flex-shrink: 0; font-size: 12px;"></i>
          <div class="small" style="font-size: 11px;">
            Tu información está protegida y cifrada.
          </div>
        </div>

      </div>
    </div>

    <!-- Lado derecho - Imagen de fondo -->
    <div class="login-image-container"></div>
  </div>

  <!-- Toast container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast-container"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    function togglePasswordVisibility(fieldId) {
      const field = document.getElementById(fieldId);
      const icon = document.getElementById(fieldId === 'password' ? 'eye-icon' : 'eye-icon-confirm');
      if (field.type === 'password') { field.type = 'text'; icon.classList.replace('bi-eye', 'bi-eye-slash'); }
      else { field.type = 'password'; icon.classList.replace('bi-eye-slash', 'bi-eye'); }
    }

    function validarPassword(p) {
      if (p.length < 8) return { ok: false, msg: 'Mínimo 8 caracteres' };
      if (!/[A-Z]/.test(p)) return { ok: false, msg: 'Incluye una mayúscula' };
      if (!/[0-9]/.test(p)) return { ok: false, msg: 'Incluye un número' };
      if (!/[!@#$%^&*(),.?":{}|<>]/.test(p)) return { ok: false, msg: 'Incluye un símbolo especial' };
      return { ok: true };
    }

    function validarEmail(e) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }

    async function registrarUsuario(event) {
      event.preventDefault();
      console.log('registrarUsuario - FIREBASE_CONFIGURED=', FIREBASE_CONFIGURED, 'auth=', auth);
      const nombre = document.getElementById('nombre').value.trim();
      const email = document.getElementById('email').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const documento = document.getElementById('documento').value.trim();
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('passwordConfirm').value;
      const terminos = document.getElementById('terminos').checked;

      if (!nombre) { showToast('Ingresa tu nombre', { type: 'warning' }); return; }
      if (!email || !validarEmail(email)) { showToast('Correo inválido', { type: 'warning' }); return; }
      if (!telefono) { showToast('Ingresa tu teléfono', { type: 'warning' }); return; }
      if (!documento) { showToast('Ingresa tu documento', { type: 'warning' }); return; }
      const v = validarPassword(password);
      if (!v.ok) { showToast(v.msg, { type: 'warning' }); return; }
      if (password !== passwordConfirm) { showToast('Las contraseñas no coinciden', { type: 'warning' }); return; }
      if (!terminos) { showToast('Acepta los términos', { type: 'warning' }); return; }

      // Firebase Auth
      if (FIREBASE_CONFIGURED && auth) {
        try {
          const cred = await auth.createUserWithEmailAndPassword(email, password);
          await cred.user.updateProfile({ displayName: nombre });
          // Save profile in Firestore
          if (db) {
            await db.collection('users').doc(cred.user.uid).set({
              perfil: {
                nombre, correo: email, telefono, documento, zona: '', tipo: '',
                servicios: { agua: true, energia: true, gas: true, internet: true },
                umbrales: { agua: { consumo: 0, valor: 0 }, energia: { consumo: 0, valor: 0 }, gas: { consumo: 0, valor: 0 }, internet: { consumo: 0, valor: 0 } }
              }
            });
          }
          showToast('¡Cuenta creada! Redirigiendo...', { type: 'success', delay: 2000 });
          document.getElementById('formularioRegistro').reset();
          setTimeout(() => { window.location.href = 'index.html'; }, 2000);
        } catch (err) {
          if (err.code === 'auth/email-already-in-use') showToast('Este correo ya está registrado', { type: 'warning' });
          else if (err.code === 'auth/weak-password') showToast('Contraseña muy débil', { type: 'warning' });
          else showToast('Error: ' + err.message, { type: 'error' });
        }
        return;
      }

      // Fallback localStorage
      const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
      if (usuarios.some(u => u.email === email)) { showToast('Correo ya registrado', { type: 'warning' }); return; }
      if (usuarios.some(u => u.documento === documento)) { showToast('Documento ya registrado', { type: 'warning' }); return; }
      usuarios.push({ id: Date.now().toString(), nombre, email, telefono, documento, password: btoa(password), fecha_registro: new Date().toISOString(), activo: true });
      localStorage.setItem('usuarios', JSON.stringify(usuarios));
      showToast('¡Cuenta creada! Redirigiendo...', { type: 'success', delay: 2000 });
      document.getElementById('formularioRegistro').reset();
      setTimeout(() => { window.location.href = 'index.html'; }, 2000);
    }

    function showToast(message, options = {}) {
      const { type = 'info', delay = 0 } = options;
      const container = document.getElementById('toast-container');
      if (!container) { alert(message); return; }
      const id = 'toast-' + Date.now();
      const cls = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-info';
      container.insertAdjacentHTML('beforeend', `<div id="${id}" class="alert ${cls} alert-dismissible fade show" role="alert"><strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
      setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, delay || 5000);
    }

    document.addEventListener('DOMContentLoaded', function () {
      const pw = document.getElementById('password'), pc = document.getElementById('passwordConfirm');
      pw.addEventListener('input', function () {
        const v = validarPassword(this.value);
        if (!v.ok && this.value.length > 0) { this.classList.remove('is-valid'); this.classList.add('is-invalid'); }
        else if (v.ok) { this.classList.remove('is-invalid'); this.classList.add('is-valid'); }
        else { this.classList.remove('is-invalid', 'is-valid'); }
      });
      pc.addEventListener('input', function () {
        if (this.value && this.value === pw.value) { this.classList.remove('is-invalid'); this.classList.add('is-valid'); }
        else if (this.value) { this.classList.remove('is-valid'); this.classList.add('is-invalid'); }
        else { this.classList.remove('is-invalid', 'is-valid'); }
      });
    });
  </script>
</body>

</html>